app.directive("infoReceiver",function(e,t){return{restrict:"E",link:function(e,o,n){e.liked=Number(e.liked),e.visitorLiked=Number(e.visitorLiked),e.bookMarked=Number(e.bookMarked),e.chapterCommented=Number(e.chapterCommented),e.commented=Number(e.commented),e.bookStatus=Number(e.bookStatus),e.index=JSON.parse(e.index),e.bookCommentList=e.bookCommentList.replace(/\n/g,"<br>"),e.bookCommentList=JSON.parse(e.bookCommentList),e.chapterCommentList=JSON.parse(e.chapterCommentList),e.likePostList=JSON.parse(e.likePostList),e.chapterCount=Number(e.chapterCount),e.feedback=JSON.parse(e.feedback),t.userId=e.authorId,t.visitorId=e.visitorId,t.readerId=e.readerId,e.feedback&&e.feedback.forEach(function(t){1===t.type?e.ifLiked=Boolean(t.status):2===t.type&&(e.ifBookMarked=Boolean(t.status))})}}}),app.directive("feedbackContent",function(e){return{restrict:"E",link:function(e,t,o){e.$watch(t[0].offsetHeight,function(){console.log("triggered")})}}}),app.filter("endClass",function(){return function(e,t){return 0===t?"· 全文完 ·":"· 未完待续 ·"}}),app.filter("fullChapter",function(){return function(e,t){let o=0;return t.forEach(function(e){e.published&&o++}),o+"/"+e}}),app.directive("codeInput",function(){return{restrict:"C",link:function(e,t,o){t.val(""),t.on("input",function(){e.validateError="";let o=t.val();e.codeVal=""===o?"":md5(o)}).on("blur",function(){e.checkVal()})}}}),app.controller("feedbackCon",function(e,t,o,n,i,r,a){e.showComment=!1,e.showFeedback=!1,e.codeError="",e.validateError="",e.validating=!1,e.bookStatus=0,e.codeVal="",e.workId="",e.chapterId="",e.authorId="",e.liked=-1,e.bookMarked=-1,e.chapterCommented=-1,e.commented=-1,e.visitorLiked=-1,e.likePostList=[],e.commentList=[],e.ifLiked=!1,e.ifBookMarked=!1,e.panelVisible=!1,e.bookVisible=!1,e.indexVisible=!1,e.isRequesting=!1,e.initializeCommentData=function(){e.infoType=0,e.targetUser=e.authorId,e.commentList=e.bookCommentList;let t=document.getElementById("bookCommentBtn"),o=t.offsetLeft-t.parentElement.offsetLeft+t.children[0].offsetWidth/2,n=document.getElementById("btnPointer");n&&(n.style.transform="translateX("+o+"px)",n.style.transition="transform 1.5s ease-in-out")},e.showBookComment=function(){0!==e.infoType&&(e.infoType=0,e.commentList=e.bookCommentList,s(e.infoType))},e.showChapterComment=function(){1!==e.infoType&&(e.infoType=1,e.commentList=e.chapterCommentList,s(e.infoType))},e.showLikeList=function(){if(2===e.infoType)return;e.infoType=2;document.getElementById("likeCommentBtn");s(e.infoType)},e.updateCommentCount=function(t){0===e.infoType?e.commented=t.commentCount:1===e.infoType&&(e.chapterCommented=t.commentCount),s(e.infoType)},e.likeIt=function(){let t={work:e.workId,user:e.authorId};a.likeIt(t)},e.nextExist=function(t){let o=!1,n=null,i=function(t){null!=n&&t.published&&(o=!0),t.chapter===e.chapterId&&(n=e.chapterId)};if(t)for(let t=e.index.length-1;t>=0;--t)i(e.index[t]);else{for(let t=0;t<e.index.length;++t)i(e.index[t])}return o},e.nextChapter=function(t){let o="/fanfic/",n=null,i=function(t){return null!=n&&t.published?(o+=t.chapter,!0):(t.chapter===e.chapterId&&(n=e.chapterId),!1)};if(t)for(let t=e.index.length-1;t>=0&&!i(e.index[t]);--t);else{for(let t=0;t<e.index.length&&!i(e.index[t]);++t);}return o},e.bookMarkIt=function(){let t={work:e.workId,user:e.authorId};a.bookMarkIt(t)};let s=function(e){let t=null;if(1===e?t=document.getElementById("chapterCommentBtn"):0===e?t=document.getElementById("bookCommentBtn"):2===e&&(t=document.getElementById("likeCommentBtn")),null==t)return;let o=t.offsetLeft-t.parentElement.offsetLeft+t.children[0].offsetWidth/2,n=document.getElementById("btnPointer");n&&(n.style.transform="translateX("+o+"px)",n.style.transition="transform 0.8s ease-in-out")};e.updateFeedBackData=function(t){if(2===e.infoType&&i(s(e.infoType),100),!t.user)return;let o={type:t.type,userName:t.userName,user:t.user,status:t.status},n=(t.status,-1);for(let o=0;o<e.likePostList.length;++o)e.likePostList[o].user===t.user&&e.likePostList[o].type===t.type&&(n=o);let r=Boolean(t.status);r&&n<0?e.likePostList.push(o):!r&&n>=0&&e.likePostList.splice(n,1)},e.$on("showError",function(t,o){e.showError=!0,e.$broadcast("showErrorText",o)}),e.$on("likeFinished",function(o,n){e.workId===n.work&&(n.success?(e.liked=n.liked,e.visitorLiked=n.visitorLiked,e.ifLiked=Boolean(n.status),e.updateFeedBackData(n)):t.$broadcast("showErrorText",n.message))}),e.$on("bookmarkFinished",function(o,n){e.workId===n.work&&(n.success?(e.bookMarked=n.bookmarked,e.ifBookMarked=n.status,e.updateFeedBackData(n)):t.$broadcast("showErrorText",n.message))}),e.switchButton=function(e,t){e.style.background=t?"rgba(158,142,166,255)":"white",e.style.color=t?"white":"rgba(158,142,166,255)",e.style.pointerEvents=t?"auto":"none"},e.showBook=function(){e.indexVisible=!1,e.bookVisible=!0,e.panelVisible=!0},e.showIndex=function(){e.bookVisible=!1,e.indexVisible=!0,e.panelVisible=!0},e.closeInfoPanel=function(){e.panelVisible=!1},e.isEnd=function(){let t=e.index[0].chapter;for(let o=0;o<e.index.length;++o)e.index[o].published&&(t=e.index[o].chapter);return e.chapterId===t},e.checkVal=function(){""===e.codeVal?e.codeError="口令密码不能为空":e.codeVal.match(/s+/)?e.codeError="口令密码不能包括空格":e.codeError=""},e.submitCode=function(){if(e.checkVal(),""!==e.codeError)return;e.validateError="";let t={code:e.codeVal,type:0};console.log(t),e.validating=!0,n.post("/fanfic/validate/"+e.chapterId,{data:JSON.stringify(t)}).then(function(t){e.validating=!1;let n=t.data;if(console.log(n),n.success){let t=new Date;t.setDate(t.getDate()+300),o.putObject(e.chapterId,n.code),r.location.reload()}else e.validateError="您输入的口令错误，请重新输入",o.getObject(e.chapterId)&&o.remove(e.chapterId)},function(t){e.validating=!1,e.validateError="网络通信错误,请重新尝试"})}});