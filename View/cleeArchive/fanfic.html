<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.12.0/js/md5.min.js"></script>
    <meta charset="UTF-8">
    <title><%- book.title %></title>

    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.8.2/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/angular@1.7.9/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/angular-cookies@1.5.9/angular-cookies.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

    <link rel="stylesheet" href="/css/archive/button.css">

    <script>var app = angular.module('cleeFanfic',['ngCookies']);</script>
    <script src="/view/cont/feedback_con.js"></script>
    <script src="/view/cont/feedbackService.js"></script>

    <script src="/view/modules/errorBox.js"></script>
    <script src="/view/modules/commentList.js"></script>

    <link href="/css/archive/fanfic.css" rel="stylesheet">
</head>

<body ng-app="cleeFanfic" ng-controller="feedbackCon">
<info-receiver
        ng-init="workId= '<%= book._id %>';
                 chapterId='<%= chapter._id %>';
                 liked='<%= book.liked %>';
                 visitorLiked = '<%= book.visitorLiked %>';
                 bookStatus = '<%= book.status %>';
                 bookMarked = '<%= book.bookmarked %>';
                 chapterCount = '<%= book.chapterCount %>';
                 index = '<%= JSON.stringify(index) %>';
                 authorId = '<%= book.user %>';
                 readerId = '<%= readerId %>';
                 visitorId = '<%= visitorId %>';
                 chapterCommented = '<%= chapter.comments %>';
                 commented = '<%= book.comments %>';
                 bookCommentList = '<%= JSON.stringify(bookComment) %>';
                 chapterCommentList = '<%= JSON.stringify(chapterComment) %>';
                 likePostList = '<%= JSON.stringify(likeList) %>';
                 feedback = '<%= JSON.stringify(book.feedback) %>';">
</info-receiver>
<div style="width:100%;position:fixed;top:0;min-height:2.5rem;display:flex;flex-direction:row;">
    <div class="error-box">

    </div>
</div>
<div id="guideBar">
    <div class="chapterJumberH"><a href="{{nextChapter(true)}}" ng-show="nextExist(true)">上一章</a></div>
    <div class="chapterJumper" ><a href="{{nextChapter(true)}}" ng-show="nextExist(true)"><i class="chapter fas fa-arrow-left"></i></a></div>

    <div class="miniInfo" ng-click="showBook()">作品</div>
    <div class="miniInfo" id="bookButton" ng-click="showBook()"><i class="fas fa-book fa-2x"></i></div>

    <% if(index.length>=1 && book.status == 1) { %>
    <div  class="miniInfo" ng-click="showIndex()">目录</div>
    <div  class="miniInfo" id="indexButton" ng-click="showIndex()"><i class="fas fa-list fa-2x"></i></div>
    <% } %>

    <% if(user._id == readerId && book.published){ %>
    <div class="ss-edit"><a href="<%- '/fanfic/post/edit?id='+chapter.indexId %>" target="_blank">编辑</a></div>
    <div class="ss-edit"><a href="<%- '/fanfic/post/edit?id='+chapter.indexId %>" target="_blank"><i class="fas fa-edit"></i></a></div>
    <% } %>

    <% if(user._id == readerId && book.published){ %>
    <div  class="ss-edit" ng-click="deleteItem()">删除</div>
    <div  class="ss-edit" ng-click="deleteItem()"><i class="fas fa-trash fa-2x"></i></div>
    <% } %>

    <div class="chapterJumberH"><a href="{{nextChapter(false)}}" ng-show="nextExist(false)">下一章</a></div>
    <div class="chapterJumper"><a href="{{nextChapter(false)}}" ng-show="nextExist(false)"><i class="chapter fas fa-arrow-right"></i></a></div>
</div>

<div id="infoScroll" ng-show="panelVisible">
    <div style="display:flex;flex-direction:row;" class="scrollFunc">
        <div class="scrollButton" ng-click="closeInfoPanel()"><i class="fas fa-arrow-alt-circle-left"></i></div>
        <div class="scrollButton fadeLink" style="margin-top:1rem;font-size:32px;" ng-click="closeInfoPanel()">收起 ↑</div>
    </div>

<!--    书籍信息界面-->
    <div id="bookInfo" ng-show="bookVisible">
        <div style="margin-top:2rem;"><span>作品名：</span><span><%- book.title %></span></div>
        <% let calcWord = function(wordNum){ %>
        <% let wordShow = wordNum+' 字'; %>
        <% if(wordNum > 999 && wordNum <= 9999){ %>
        <% wordShow = (wordNum/1000).toFixed(2)+' 千字'; %>
        <% } else if(wordNum > 9999){ %>
        <% wordShow = (wordNum/10000).toFixed(2)+' 万字';} %>
        <% return wordShow; %>
        <% } %>
        <div><span>总字数：</span><span><%- calcWord(book.wordCount) %></span></div>
        <div><span>章节数：</span><span>{{chapterCount | fullChapter:index}}章</span></div>
        <div class="timeInfo">
            <span>发布于：</span>
            <div>
                <% let publishTime= new Date(book.updated) %>
                <div><%- publishTime.getFullYear() %>年<%- publishTime.getMonth() %>月<%- publishTime.getDate() %>日</div>
                <div><%- publishTime.getHours() %>时<%- publishTime.getMinutes() %>分<%- publishTime.getSeconds() %>秒</div>
            </div>
        </div>
        <div class="timeInfo">
            <span>更新于：</span>
            <div>
                <% publishTime= new Date(book.updated) %>
                <div><%- publishTime.getFullYear() %>年<%- publishTime.getMonth() %>月<%- publishTime.getDate() %>日</div>
                <div><%- publishTime.getHours() %>时<%- publishTime.getMinutes() %>分<%- publishTime.getSeconds() %>秒</div>
            </div>
        </div>
    </div>

<!--    目录界面-->
    <div id="indexInfo" ng-show="indexVisible">
        <% var chapterCount = function(num){ %>
        <% if(num ==0 ) { %>
        <%       return '首章'; %>
        <% } else { %>
        <%      return '第' + num +'章'; }%>
        <% }%>

        <% for (let i=0; i< index.length;++i) {%>
        <% if(index[i]._id == chapter.indexId){ %>
        <div style="font-weight:bold;color:gray;" >
            <div><%- chapterCount(index[i].order) %></div>
            <div style="margin-left:5px;flex:1;text-overflow: ellipsis;word-break: break-all;overflow:hidden;">
                     <span> <%- index[i].title %> </span>
            </div>
        </div>
        <% } else if(index[i].published){ %>
        <div> <a href="<%- '/fanfic/'+index[i].chapter %>">
            <div><%- chapterCount(index[i].order) %></div>
            <div style="margin-left:5px;flex:1;text-overflow: ellipsis;word-break: break-all;overflow:hidden;"><%- index[i].title %></div>
        </a></div>
        <% } }%>
    </div>
</div>

<div id="main">
    <h1 style="min-height:2.5rem;">
        <% if(chapter.grade <= 1){ %>
        <div class="grade"><%- fanfic_grade[chapter.grade].refer %></div>
        <% }else{ %>
        <div class="grade" style="background:rgba(251,161,0,255);"><%- fanfic_grade[chapter.grade].refer %></div>
        <% } %>
        <%- title %>
    </h1>
    <h2>
       <span>
            <span>作者：</span><a href="<%- '/users/'+user._id %>" target="_blank"><%- user.user %></a>
        </span>
        <% if(index.length >1 || book.status == 1) {%>
        <span>
            <span>属于作品：</span>
            <div class='fadeLink' ng-click="showBook()"><%- book.title %></div>
        </span>
        <% } %>
        <span>
            <span>总字数：</span>
            <span><%- calcWord(chapter.wordCount) %></span>
        </span>
        <span>
            <span>点赞数：</span>
            <span>{{liked}}</span>
        </span>
        <span>
            <span>被收藏：</span>
            <span><%- book.bookmarked %></span>
        </span>
        <span>
            <span>阅读量：</span>
            <span><%- chapter.visited %></span>
        </span>
        <span>
            <span>更新于:</span>
            <% let updateTime= new Date(chapter.date) %>
            <span><%- updateTime.getFullYear() %>年<%- updateTime.getMonth() %>月<%- updateTime.getDate() %>日</span>
            <span><%- updateTime.getHours() %>时<%- updateTime.getMinutes() %>分<%- updateTime.getSeconds() %>秒</span>
        </span>
    </h2>
    <% if(chapter.notes!='') {%>
       <div class="notes">
           <div class="emphasize infoEmphasize" style="margin-bottom:0.5rem;">作者的话：</div>
           <div style="margin-left:2rem;">
               <%- chapter.notes %>
           </div>
       </div>
    <% } %>
    <div style="margin-bottom:4rem;"></div>

    <% if(chapter.passcode.use && !codeMatch) {%>
    <div style="display:flex;flex:1;min-height:calc(100% - 20rem);flex-direction:column;margin-left:auto;margin-right:auto;">
        <div style="margin-top:auto;margin-bottom:10px;">本文作者决定不向公众公开该作品，该文章仅做个人存档之用。</div>
        <form class="requestForm">
            <div style="margin-top:3rem;">
                <div style="font-weight:bold;">分享口令：</div>
                <div style="display:flex;flex-direction:row;">
                    <input style="flex:1;" class="code-input" type="text" autocapitalize="off" autocorrect="off" placeholder="请输入口令">
                    <div id="checkingPassword" style="color:rgba(251,161,0,255);flex-direction:row;" ng-show="validating"><img src="/img/loading.gif" style="width:22px;height:22px;"> <span>密码验证中，请稍后</span></div>
                </div>
            </div>
            <div style="color:darkred;margin-left:auto;margin-right:auto;margin-bottom:0;margin-top:15px;font-weight:bold;">{{validateError}}</div>
            <div style="margin-top:2rem;">
                <button id="submitBtn" type="button" style="margin-right:-5rem;margin-left:auto;" ng-click="submitCode()">提交</button>
            </div>
        </form>


        <div style="color:rgba(251,161,0,255);margin-left:auto;margin-right:auto;margin-bottom:100px;"> {{codeError}}</div>
    </div>
    <% } else { %>
    <div id="tagInfo">
        <div>
            <div>
                <span>基于作品：</span>
                <% for(let i=0;i < chapter.fandom.length;++i){ %>
                <a href="<%- '/search/tag?id='+ escape(chapter.fandom[i]) %>" target="_blank"><%- chapter.fandom[i] %></a>
                <% if(i < chapter.fandom.length-1){ %><span>,</span><% } %>
                <% } %>
            </div>
            <div>
                <span>登场角色：</span>
                <% for(let i=0;i < chapter.characters.length;++i){ %>
                <a href="<%- '/search/tag?id='+ escape(chapter.characters[i]) %>" target="_blank"><%- chapter.characters[i] %></a>
                <% if(i < chapter.characters.length-1){ %> <span>,</span><% } %>
                <% } %>
            </div>
            <div>
                <span>人物关系：</span>
                <% for(let i=0;i < chapter.relationships.length;++i){ %>
                <a href="<%- '/search/tag?id='+ escape(chapter.relationships[i]) %>" target="_blank"><%- chapter.relationships[i] %></a>
                <% if(i < chapter.relationships.length-1){ %><span>,</span><% } %>
                <% } %>
            </div>
            <div>
                <span>其他标签：</span>
                <% for(let i=0;i < chapter.tag.length;++i){ %>
                <a href="<%- '/search/tag?id='+ escape(chapter.tag[i]) %>" target="_blank"><%- chapter.tag[i] %></a>
                <% if(i < chapter.tag.length-1){ %><span>,</span><% } %>
                <% }; %>
            </div>
            <div></div>
        </div>
    </div>
    <div id="warningPanel" class="warning infoPanel">
        <div class="emphasize infoEmphasize" style="margin-left:0;">作者警告:</div>
        <% if(chapter.warning.length >0) {%>
        <div>
            <ul>
                <% chapter.warning.forEach(function(item){%>
                <li><%= item %></li>
                <% }) %>
            </ul>
        </div>
        <% } else {%>
               <div>作者选择不使用文前警告</div>
        <% } %>
        <div style="margin-top:2rem;"></div>
    </div>
    <div class="infoDash"></div>
    <div style="margin-top:2rem;"></div>

    <div id="contents" style="flex:1;min-width:28rem;width:90%;margin-left:auto;margin-right:auto;">
        <%- chapter.contents %>
    </div>

    <div style="margin-bottom:2rem;"></div>
    <div class="end" style="padding-bottom:2rem;" ng-show="isEnd()">{{"· 全文完 · " | endClass:bookStatus}}</div>
    <% } %>
    <div id="feedbackRow">
        <button id="likeCommentBtn" ng-click="showLikeList()" class="feedbackButton"><span>热度</span>({{liked+bookMarked}})</button>
        <% if(user._id != readerId){ %>
        <button ng-click="likeIt()" ng-class="{'feedbackButton':!ifLiked,'likedButton':ifLiked}"><span ng-show="ifLiked">已点赞</span><span ng-show="!ifLiked">点赞</span>({{liked}})</button>
        <button ng-click="bookMarkIt()" ng-class="{'feedbackButton':!ifBookMarked,'likedButton':ifBookMarked}"><span ng-show="ifBookMarked">已收藏</span><span ng-show="!ifBookMarked">收藏</span>({{bookMarked}})</button>
        <% } %>
        <button id="chapterCommentBtn" ng-click="showChapterComment()" class="feedbackButton" ng-disabled="infoType==1"><span>评论</span><span>({{chapterCommented}})</span></button>
        <button id="bookCommentBtn" ng-click="showBookComment()" class="feedbackButton" ng-disabled="infoType==0"><span>作品评论</span><span>({{commented}})</span></button>
    </div>
    <div id="arrowRow">
        <div id="btnPointer"><i class="fa fa-angle-up fa-2x"></i></div>
    </div>
    <div id="feedback">
        <div style="min-height:4.5rem;"></div>
        <div class="feedback-content" ng-show="infoType < 2">
            <comment-info></comment-info>
        </div>
        <div class="feedback-content" ng-show="infoType == 2">
            <div class="feedbackEntry" ng-show="visitorLiked >0" style="border-bottom:none;">
                <div>共有<b style="margin-left:5px;margin-right:5px;">{{visitorLiked}}</b>名游客点赞了您</div>
            </div>
            <div style="min-height:15px;" ng-show="likePostList.length>0"></div>
            <div ng-repeat="feedback in likePostList">
                <div class="feedbackEntry"><a href="{{'/users/'+feedback.user}}" target="_blank">{{feedback.userName}}</a> <span ng-if="feedback.type==1">点赞了</span><span ng-if="feedback.type==2">收藏了</span>此作品</div>
            </div>
        </div>
        <div class="clear" style="min-height:2rem;width:100%;clear:both;"></div>
    </div>
</div>
</body>
</html>