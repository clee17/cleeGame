!function(e){!function(t){var r=function(){return function(e){this.tileAnim=[0,0],this.dontUseTransform=!1,this.renderer=e,this.tileAnim=[0,0]}}();t.CanvasTileRenderer=r,e.CanvasRenderer.registerPlugin("tilemap",r)}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={}));var PIXI,__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();!function(e){!function(t){var r=function(r){function i(e,t,i,n){var a=r.call(this)||this;return a.shadowColor=new Float32Array([0,0,0,.5]),a.modificationMarker=0,a._globalMat=null,a._tempScale=null,a.initialize.apply(a,arguments),a}return __extends(i,r),i.prototype.updateTransform=function(){r.prototype.displayObjectUpdateTransform.call(this)},i.prototype.initialize=function(e,t,r,i){this.z=this.zIndex=e,this.useSquare=r,this.texPerChild=i||16,t&&this.setBitmaps(t)},i.prototype.setBitmaps=function(e){var r,i=this.texPerChild,n=this.children.length,a=Math.ceil(e.length/i);for(r=0;r<n;r++)this.children[r].textures=e.slice(r*i,(r+1)*i);for(r=n;r<a;r++)this.addChild(new t.RectTileLayer(this.zIndex,e.slice(r*i,(r+1)*i)))},i.prototype.clear=function(){for(var e=0;e<this.children.length;e++)this.children[e].clear();this.modificationMarker=0},i.prototype.addRect=function(e,t,r,i,n,a,o){this.children[e]&&this.children[e].textures&&this.children[e].addRect(0,t,r,i,n,a,o)},i.prototype.addFrame=function(r,i,n,a,o){var s,u=null,h=0,l=this.children;if("number"==typeof r){if(u=l[r/this.texPerChild>>0])h=r%this.texPerChild;else{if(!(u=l[0]))return!1;h=0}s=u.textures[h]}else if("string"==typeof r)s=e.Texture.fromImage(r);else{s=r;for(var d=0;d<l.length;d++){for(var f=(p=l[d]).textures,c=0;c<f.length;c++)if(f[c].baseTexture==s.baseTexture){u=p,h=c;break}if(u)break}if(!u){for(d=0;d<l.length;d++){var p;if((p=l[d]).textures.length<this.texPerChild){u=p,h=p.textures.length,p.textures.push(s);break}}u||(l.push(u=new t.RectTileLayer(this.zIndex,s)),h=0)}}return u.addRect(h,s.frame.x,s.frame.y,i,n,s.frame.width,s.frame.height,a,o),!0},i.prototype.renderCanvas=function(e){if(!e.plugins.tilemap.dontUseTransform){var t=this.worldTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution)}for(var r=this.children,i=0;i<r.length;i++)r[i].renderCanvas(e)},i.prototype.renderWebGL=function(t){t.gl;var r=t.plugins.tilemap.getShader(this.useSquare);if(t.setObjectRenderer(t.plugins.tilemap),t.bindShader(r),this._globalMat=this._globalMat||new e.Matrix,t._activeRenderTarget.projectionMatrix.copy(this._globalMat).append(this.worldTransform),r.uniforms.projectionMatrix=this._globalMat.toArray(!0),r.uniforms.shadowColor=this.shadowColor,this.useSquare){var i=this._tempScale=this._tempScale||[0,0];i[0]=this._globalMat.a>=0?1:-1,i[1]=this._globalMat.d<0?1:-1;r.uniforms.pointScale=i;r.uniforms.projectionScale=Math.abs(this.worldTransform.a)*t.resolution}r.uniforms.animationFrame=t.plugins.tilemap.tileAnim;for(var n=this.children,a=0;a<n.length;a++)n[a].renderWebGL(t,this.useSquare)},i.prototype.isModified=function(e){var t=this.children;if(this.modificationMarker!=t.length)return!0;for(var r=0;r<t.length;r++){var i=t[r];if(i.modificationMarker!=i.pointsBuf.length||e&&i.hasAnim)return!0}return!1},i.prototype.clearModify=function(){var e=this.children;this.modificationMarker=e.length;for(var t=0;t<e.length;t++){var r=e[t];r.modificationMarker=r.pointsBuf.length}},i}(e.Container);t.CompositeRectTileLayer=r}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={})),function(e){e.tilemap||(e.tilemap={}),function(t){function r(e){var r=t.call(this)||this;return r.z=r.zIndex=e,r}__extends(r,t),r.prototype.renderCanvas=function(t){var r=null;t.plugins.tilemap.dontUseTransform&&(r=this.transform.worldTransform,this.transform.worldTransform=e.Matrix.IDENTITY),t.plugins.graphics.render(this),t.plugins.tilemap.dontUseTransform&&(this.transform.worldTransform=r),t.context.globalAlpha=1},r.prototype.renderWebGL=function(e){this._webGL[e.CONTEXT_UID]||(this.dirty=!0),t.prototype.renderWebGL.call(this,e)},r.prototype.isModified=function(e){return!1},r.prototype.clearModify=function(){}}(e.Graphics)}(PIXI||(PIXI={})),function(e){!function(t){var r=function(e){function t(t,r){var i=e.call(this)||this;return i.z=0,i.zIndex=0,i.pointsBuf=[],i._tempSize=new Float32Array([0,0]),i._tempTexSize=1,i.modificationMarker=0,i.hasAnim=!1,i.vbId=0,i.vbBuffer=null,i.vbArray=null,i.vbInts=null,i.initialize(t,r),i}return __extends(t,e),t.prototype.initialize=function(e,t){t?t instanceof Array||!t.baseTexture||(t=[t]):t=[],this.textures=t,this.z=this.zIndex=e,this.visible=!1},t.prototype.clear=function(){this.pointsBuf.length=0,this.modificationMarker=0,this.hasAnim=!1},t.prototype.renderCanvas=function(e){if(0!==this.textures.length){var t=this.pointsBuf;e.context.fillStyle="#000000";for(var r=0,i=t.length;r<i;r+=9){var n=t[r],a=t[r+1],o=t[r+2],s=t[r+3],u=t[r+4],h=t[r+5];n+=t[r+6]*e.plugins.tilemap.tileAnim[0],a+=t[r+7]*e.plugins.tilemap.tileAnim[1];var l=t[r+8];l>=0?e.context.drawImage(this.textures[l].baseTexture.source,n,a,u,h,o,s,u,h):(e.context.globalAlpha=.5,e.context.fillRect(o,s,u,h),e.context.globalAlpha=1)}}},t.prototype.addRect=function(e,t,r,i,n,a,o,s,u){void 0===s&&(s=0),void 0===u&&(u=0);var h,l=this.pointsBuf;if(this.hasAnim=this.hasAnim||s>0||u>0,a==o)l.push(t),l.push(r),l.push(i),l.push(n),l.push(a),l.push(o),l.push(0|s),l.push(0|u),l.push(e);else if(a%o==0)for(h=0;h<a/o;h++)l.push(t+h*o),l.push(r),l.push(i+h*o),l.push(n),l.push(o),l.push(o),l.push(0|s),l.push(0|u),l.push(e);else if(o%a==0)for(h=0;h<o/a;h++)l.push(t),l.push(r+h*a),l.push(i),l.push(n+h*a),l.push(a),l.push(a),l.push(0|s),l.push(0|u),l.push(e);else l.push(t),l.push(r),l.push(i),l.push(n),l.push(a),l.push(o),l.push(0|s),l.push(0|u),l.push(e)},t.prototype.renderWebGL=function(e,t){void 0===t&&(t=!1);var r=this.pointsBuf;if(0!==r.length){var i=r.length/9,n=e.plugins.tilemap,a=e.gl;t||n.checkIndexBuffer(i);var o=n.getShader(t),s=this.textures;if(0!==s.length){var u=s.length;this._tempTexSize<o.maxTextures&&(this._tempTexSize=o.maxTextures,this._tempSize=new Float32Array(2*o.maxTextures));for(var h=0;h<u;h++){if(!s[h]||!s[h].valid)return;s[h].baseTexture}n.bindTextures(e,o,s);var l=n.getVb(this.vbId);l||(l=n.createVb(t),this.vbId=l.id,this.vbBuffer=null,this.modificationMarker=0);var d=l.vao;e.bindVao(d);var f=l.vb;f.bind();var c=i*o.vertPerQuad;if(0!==c){if(this.modificationMarker!=c){this.modificationMarker=c;var p=o.stride*c;if(!this.vbBuffer||this.vbBuffer.byteLength<p){for(var v=o.stride;v<p;)v*=2;this.vbBuffer=new ArrayBuffer(v),this.vbArray=new Float32Array(this.vbBuffer),this.vbInts=new Uint32Array(this.vbBuffer),f.upload(this.vbBuffer,0,!0)}var m,x,T,g=this.vbArray,b=(this.vbInts,0);if(t)for(h=0;h<r.length;h+=9)m=r[h+8]>>2,x=1024*(1&r[h+8]),T=1024*(r[h+8]>>1&1),g[b++]=r[h+2],g[b++]=r[h+3],g[b++]=r[h+0]+x,g[b++]=r[h+1]+T,g[b++]=r[h+4],g[b++]=r[h+6],g[b++]=r[h+7],g[b++]=m;else{for(h=0;h<r.length;h+=9){m=r[h+8]>>2,x=1024*(1&r[h+8]),T=1024*(r[h+8]>>1&1);var y=r[h+2],S=r[h+3],I=r[h+4],_=r[h+5],A=r[h]+x,C=r[h+1]+T,w=r[h+6],L=r[h+7];g[b++]=y,g[b++]=S,g[b++]=A,g[b++]=C,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m,g[b++]=y+I,g[b++]=S,g[b++]=A+I,g[b++]=C,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m,g[b++]=y+I,g[b++]=S+_,g[b++]=A+I,g[b++]=C+_,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m,g[b++]=y,g[b++]=S+_,g[b++]=A,g[b++]=C+_,g[b++]=A+.5,g[b++]=C+.5,g[b++]=A+I-.5,g[b++]=C+_-.5,g[b++]=w,g[b++]=L,g[b++]=m}}f.upload(g,0,!0)}t?a.drawArrays(a.POINTS,0,c):a.drawElements(a.TRIANGLES,6*i,a.UNSIGNED_SHORT,0)}}}},t}(e.Container);t.RectTileLayer=r}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={})),function(e){!function(t){var r="varying vec2 vTextureCoord;\nvarying vec4 vFrame;\nvarying float vTextureId;\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\n\nvoid main(void){\n   vec2 textureCoord = clamp(vTextureCoord, vFrame.xy, vFrame.zw);\n   float textureId = floor(vTextureId + 0.5);\n\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}",i="\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aFrame;\nattribute vec2 aAnim;\nattribute float aTextureId;\n\nuniform mat3 projectionMatrix;\nuniform vec2 animationFrame;\n\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vFrame;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vec2 anim = aAnim * animationFrame;\n   vTextureCoord = aTextureCoord + anim;\n   vFrame = aFrame + vec4(anim, anim);\n   vTextureId = aTextureId;\n}\n",n=function(e){function r(r,i,n,a){var o=e.call(this,r,n,a)||this;return o.maxTextures=0,o.maxTextures=i,t.shaderGenerator.fillSamplers(o,o.maxTextures),o}return __extends(r,e),r}(e.Shader);t.TilemapShader=n;var a=function(e){function n(n,a){var o=e.call(this,n,a,i,t.shaderGenerator.generateFragmentSrc(a,r))||this;return o.vertSize=11,o.vertPerQuad=4,o.stride=4*o.vertSize,t.shaderGenerator.fillSamplers(o,o.maxTextures),o}return __extends(n,e),n.prototype.createVao=function(e,t){var r=e.gl;return e.createVao().addIndex(this.indexBuffer).addAttribute(t,this.attributes.aVertexPosition,r.FLOAT,!1,this.stride,0).addAttribute(t,this.attributes.aTextureCoord,r.FLOAT,!1,this.stride,8).addAttribute(t,this.attributes.aFrame,r.FLOAT,!1,this.stride,16).addAttribute(t,this.attributes.aAnim,r.FLOAT,!1,this.stride,32).addAttribute(t,this.attributes.aTextureId,r.FLOAT,!1,this.stride,40)},n}(n);t.RectTileShader=a}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={})),function(e){!function(e){!function(e){e.fillSamplers=function(e,t){for(var r=[],i=0;i<t;i++)r[i]=i;e.bind(),e.uniforms.uSamplers=r;var n=[];for(i=0;i<t;i++)n.push(1/2048),n.push(1/2048);e.uniforms.uSamplerSize=n},e.generateFragmentSrc=function(e,t){return t.replace(/%count%/gi,e+"").replace(/%forloop%/gi,this.generateSampleSrc(e))},e.generateSampleSrc=function(e){var t="";t+="\n",t+="\n",t+="if(vTextureId <= -1.0) {",t+="\n\tcolor = shadowColor;",t+="\n}";for(var r=0;r<e;r++)t+="\nelse ",r<e-1&&(t+="if(textureId == "+r+".0)"),t+="\n{",t+="\n\tcolor = texture2D(uSamplers["+r+"], textureCoord * uSamplerSize["+r+"]);",t+="\n}";return t+="\n",t+="\n"}}(e.shaderGenerator||(e.shaderGenerator={}))}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={})),function(e){!function(e){var t="\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec2 aAnim;\nattribute float aTextureId;\nattribute float aSize;\n\nuniform mat3 projectionMatrix;\nuniform vec2 samplerSize;\nuniform vec2 animationFrame;\nuniform float projectionScale;\n\nvarying vec2 vTextureCoord;\nvarying float vSize;\nvarying float vTextureId;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition + aSize * 0.5, 1.0)).xy, 0.0, 1.0);\n   gl_PointSize = aSize * projectionScale;\n   vTextureCoord = aTextureCoord + aAnim * animationFrame;\n   vTextureId = aTextureId;\n   vSize = aSize;\n}\n",r="\nvarying vec2 vTextureCoord;\nvarying float vSize;\nvarying float vTextureId;\n\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\nuniform vec2 pointScale;\n\nvoid main(void){\n   float margin = 0.5 / vSize;\n   vec2 pointCoord = (gl_PointCoord - 0.5) * pointScale + 0.5;\n   vec2 clamped = vec2(clamp(pointCoord.x, margin, 1.0 - margin), clamp(pointCoord.y, margin, 1.0 - margin));\n   vec2 textureCoord = pointCoord * vSize + vTextureCoord;\n   float textureId = vTextureId;\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}\n\n",i=function(i){function n(n,a){var o=i.call(this,n,a,t,e.shaderGenerator.generateFragmentSrc(a,r))||this;return o.vertSize=8,o.vertPerQuad=1,o.stride=4*o.vertSize,o.maxTextures=a,e.shaderGenerator.fillSamplers(o,o.maxTextures),o}return __extends(n,i),n.prototype.createVao=function(e,t){var r=e.gl;return e.createVao().addIndex(this.indexBuffer).addAttribute(t,this.attributes.aVertexPosition,r.FLOAT,!1,this.stride,0).addAttribute(t,this.attributes.aTextureCoord,r.FLOAT,!1,this.stride,8).addAttribute(t,this.attributes.aSize,r.FLOAT,!1,this.stride,16).addAttribute(t,this.attributes.aAnim,r.FLOAT,!1,this.stride,20).addAttribute(t,this.attributes.aTextureId,r.FLOAT,!1,this.stride,28)},n}(e.TilemapShader);e.SquareTileShader=i}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={})),function(e){!function(t){var r=e.glCore;function i(e,t,r,i,n){var a=e.gl,o=t.texture.baseTexture;r&&i>0&&n>0&&a.texSubImage2D(a.TEXTURE_2D,0,t.position.x,t.position.y,i,n,e.format,e.type,r),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),a.texSubImage2D(a.TEXTURE_2D,0,t.position.x,t.position.y,e.format,e.type,o.source)}var n=function(n){function a(e){var t=n.call(this,e)||this;return t.vbs={},t.indices=new Uint16Array(0),t.lastTimeCheck=0,t.tileAnim=[0,0],t.maxTextures=4,t.texLoc=[],t}return __extends(a,n),a.prototype.onContextChange=function(){var e=this.renderer.gl,r=this.maxTextures;this.rectShader=new t.RectTileShader(e,r),this.squareShader=new t.SquareTileShader(e,r),this.checkIndexBuffer(2e3),this.rectShader.indexBuffer=this.indexBuffer,this.squareShader.indexBuffer=this.indexBuffer,this.vbs={},this.glTextures=[],this.boundSprites=[],this.initBounds()},a.prototype.initBounds=function(){this.renderer.gl;var t=document.createElement("canvas");t.width=2048,t.height=2048;for(var r=0;r<this.maxTextures;r++){var i=e.RenderTexture.create(2048,2048);i.baseTexture.premultipliedAlpha=!0,i.baseTexture.scaleMode=a.SCALE_MODE,i.baseTexture.wrapMode=e.WRAP_MODES.CLAMP,this.renderer.textureManager.updateTexture(i),this.glTextures.push(i);for(var n=[],o=0;o<4;o++){var s=new e.Sprite;s.position.x=1024*(1&o),s.position.y=1024*(o>>1),n.push(s)}this.boundSprites.push(n)}},a.prototype.bindTextures=function(e,t,r){var n=this.boundSprites,o=this.glTextures,s=r.length,u=this.maxTextures;if(!(s>4*u)){var h,l=a.DO_CLEAR;for(l&&!this._clearBuffer&&(this._clearBuffer=new Uint8Array(4194304)),h=0;h<s;h++){var d=r[h];if(d&&r[h].valid){var f=n[h>>2][3&h];if(!f.texture||f.texture.baseTexture!==d.baseTexture){f.texture=d;var c=o[h>>2];e.bindTexture(c,0,!0),l?i(c.baseTexture._glTextures[e.CONTEXT_UID],f,this._clearBuffer,1024,1024):i(c.baseTexture._glTextures[e.CONTEXT_UID],f)}}}for(this.texLoc.length=0,h=0;h<u;h++)this.texLoc.push(e.bindTexture(o[h],h,!0));t.uniforms.uSamplers=this.texLoc}},a.prototype.checkLeaks=function(){var e=Date.now(),t=e-1e4;if(this.lastTimeCheck<t||this.lastTimeCheck>e){this.lastTimeCheck=e;var r=this.vbs;for(var i in r)r[i].lastTimeAccess<t&&this.removeVb(i)}},a.prototype.start=function(){this.renderer.state.setBlendMode(e.BLEND_MODES.NORMAL)},a.prototype.getVb=function(e){this.checkLeaks();var t=this.vbs[e];return t?(t.lastAccessTime=Date.now(),t):null},a.prototype.createVb=function(t){var r=++a.vbAutoincrement,i=this.getShader(t),n=this.renderer.gl,o=e.glCore.GLBuffer.createVertexBuffer(n,null,n.STREAM_DRAW),s={id:r,vb:o,vao:i.createVao(this.renderer,o),lastTimeAccess:Date.now(),useSquare:t,shader:i};return this.vbs[r]=s,s},a.prototype.removeVb=function(e){this.vbs[e]&&(this.vbs[e].vb.destroy(),this.vbs[e].vao.destroy(),delete this.vbs[e])},a.prototype.checkIndexBuffer=function(e){var t=6*e,i=this.indices;if(!(t<=i.length)){for(var n=i.length||t;n<t;)n<<=1;i=new Uint16Array(n),this.indices=i;for(var a=0,o=0;a+5<i.length;a+=6,o+=4)i[a+0]=o+0,i[a+1]=o+1,i[a+2]=o+2,i[a+3]=o+0,i[a+4]=o+2,i[a+5]=o+3;if(this.indexBuffer)this.indexBuffer.upload(i);else{var s=this.renderer.gl;this.indexBuffer=r.GLBuffer.createIndexBuffer(s,this.indices,s.STATIC_DRAW)}}},a.prototype.getShader=function(e){return e?this.squareShader:this.rectShader},a.prototype.destroy=function(){n.prototype.destroy.call(this),this.rectShader.destroy(),this.squareShader.destroy(),this.rectShader=null,this.squareShader=null},a}(e.ObjectRenderer);n.vbAutoincrement=0,n.SCALE_MODE=e.SCALE_MODES.LINEAR,n.DO_CLEAR=!1,t.TileRenderer=n,e.WebGLRenderer.registerPlugin("tilemap",n)}(e.tilemap||(e.tilemap={}))}(PIXI||(PIXI={})),function(e){var t,r;t=e.tilemap||(e.tilemap={}),r=function(t){function r(e,r){var i=t.call(this)||this;return i._lastAnimationFrame=-1,i.tilemap=e,i.z=r,i}return __extends(r,t),r.prototype.clear=function(){for(var e=this.children,t=0;t<e.length;t++)e[t].clear();this._previousLayers=0},r.prototype.cacheIfDirty=function(){var t=this.tilemap,r=this.children,i=this._previousLayers!=r.length;this._previousLayers=r.length;var n,a=this.canvasBuffer,o=this._tempRender;if(a||(a=this.canvasBuffer=document.createElement("canvas"),(o=this._tempRender=new e.CanvasRenderer(100,100,{view:a})).context=o.rootContext,o.plugins.tilemap.dontUseTransform=!0),a.width==t._layerWidth&&a.height==t._layerHeight||(a.width=t._layerWidth,a.height=t._layerHeight,i=!0),!i)for(n=0;n<r.length;n++)if(r[n].isModified(this._lastAnimationFrame!=t.animationFrame)){i=!0;break}if(this._lastAnimationFrame=t.animationFrame,i)for(t._hackRenderer&&t._hackRenderer(o),o.context.clearRect(0,0,a.width,a.height),n=0;n<r.length;n++)r[n].clearModify(),r[n].renderCanvas(o);for(this.layerTransform=this.worldTransform,n=0;n<r.length;n++){this.layerTransform=r[n].worldTransform;break}},r.prototype.renderCanvas=function(e){this.cacheIfDirty();var t=this.layerTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution);this.tilemap;e.context.drawImage(this.canvasBuffer,0,0)},r}(e.Container),t.ZLayer=r}(PIXI||(PIXI={}));